<html>
	<head>
		<title>Garbage Discharge Count System</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
	</head>
	<body>
		<h3>In Progress task 1 for 70% complete of 3 tasks</h3>
		<div id="control1"></div>
		<div id="cam" style="margin:1em 0em;">
			<div style="width:100%;max-width:10em;float:left;position:relative;">
				<video autoplay id="vid" style="width:100%;"></video>
				<svg id="vsvg" style="position:absolute;top:0px;left:0px;border:solid 1px black;">
					<line id="vsvgl" x1="0" y1="0" x2="200" y2="200" style="stroke:green;stroke-width:1" />
				</svg>
			</div>
			<div style="float:left;">
				<canvas id="ccam"></canvas>
			</div>
			<div style="float:left;">
				<canvas id="cv"></canvas>
			</div>
		</div>
		<table style="width:100%">
			<tr>
				<td style="width:10em;">Base</td>
				<td><input type="color" id="colbase"></input></td>
			</tr>
			<tr>
				<td style="width:10em;">Count (now)</td>
				<td>xyz</td>
			</tr>
			<tr>
				<td style="width:10em;">Count (begin)</td>
				<td>xyz</td>
			</tr>
			<tr>
				<td style="width:10em;">Data (JSON)</td>
				<td>...</td>
			</tr>
		</table>
		
		<script>
			var _cam, pro, ctx_ccam, ctx_cv, data=[];
			navigator.mediaDevices.enumerateDevices().then(function(dev){
				_cam = dev;
				for(i in dev){
					var but = document.createElement("button");
					but.setAttribute("onclick", `cam(document.getElementById("vid"), _cam[${i}])`);
					but.innerHTML = `${dev[i].kind}<br />${dev[i].label}`;
					document.getElementById("control1").append(but)
				}
			});
			
			setInterval(function(){
				vsvg.style.width = vid.offsetWidth;
				vsvg.style.height = vid.offsetHeight;
				vsvgl.setAttribute("x1", 0)
				vsvgl.setAttribute("y1", vsvg.clientHeight - (vsvg.clientHeight / 3));
				vsvgl.setAttribute("x2", vsvg.clientWidth)
				vsvgl.setAttribute("y2", vsvg.clientHeight - (vsvg.clientHeight / 3));
				
				ccam.style.width = vid.offsetWidth
				ccam.style.height = vid.offsetHeight
				cv.style.width = ccam.style.width
				cv.style.height = ccam.style.height
				main();
			},100);
			
			function hex2HSL(hex) {
				var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				r = parseInt(result[1], 16);
				g = parseInt(result[2], 16);
				b = parseInt(result[3], 16);
				r /= 255, g /= 255, b /= 255;
				var max = Math.max(r, g, b), min = Math.min(r, g, b);
				var h, s, l = (max + min) / 2;
				if(max == min){
					h = s = 0; // achromatic
				}else{
					var d = max - min;
					s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
					switch(max){
						case r: h = (g - b) / d + (g < b ? 6 : 0); break;
						case g: h = (b - r) / d + 2; break;
						case b: h = (r - g) / d + 4; break;
					}
					h /= 6;
				}
				return {h,s,l};
			}
			
			function rgb2hex(r,g,b){
				var r = r.toString(16);
				var g = g.toString(16);
				var b = b.toString(16);
				return (r.length == 1 ? "0" : "") + r + (g.length == 1 ? "0" : "") + g + (b.length == 1 ? "0" : "") + b
			}
			
			function colDifHSL(hex1, hex2){
				var hsl1 = hex2HSL(hex1), hsl2 = hex2HSL(hex2);
				var l = Math.abs((hsl2.l - hsl1.l));
				var s = Math.abs((hsl2.s - hsl1.s));
				var h = Math.abs((hsl2.h - hsl1.h)) * 360;
				h = (h <= 120 ? (h*10/360) : h <= 240 ? (h*5/360) : h <= 360 ? ((360-h)*10/360) : h/360)/(10/6);
				
				return [h,s,l];
			}
			
			function getY(x, x1, y1, x2, y2){
				return ((x-x1)*(y2-y1)/(x2-x1))+y1
			}
			
			function main(){
				ctx_ccam = ccam.getContext('2d');
				ctx_ccam.drawImage(vid, 0, 0, ccam.width, ccam.height);
				
				ctx_cv = cv.getContext("2d");
				
				for(var x=0;x<cv.width;x++){
					(function(x){
						var x = x;
						var y = cv.height - (cv.height/3);
						if(x-1 <= -1) data = [];
						setTimeout(function(){
							var dtimg = ctx_ccam.getImageData(x,y,1,1);
							var frm = [
								       x-1 < 0 ? false : ctx_ccam.getImageData(x-1,y,1,1),
								                         ctx_ccam.getImageData(x,y,1,1),
								x+1 > cv.width ? false : ctx_ccam.getImageData(x+1,y,1,1)
							]
							var hex = [
								frm[0] != false ? rgb2hex(frm[0].data[0], frm[0].data[1], frm[0].data[2]) : false,
								frm[0] != false ? rgb2hex(frm[1].data[0], frm[1].data[1], frm[1].data[2]) : false,
								frm[0] != false ? rgb2hex(frm[2].data[0], frm[2].data[1], frm[2].data[2]) : false,
							];
							
							ctx_cv.beginPath();
							ctx_cv.rect(x, y, 1, 1);
							ctx_cv.fillStyle = `rgba(${dtimg.data[0]}, ${dtimg.data[1]}, ${dtimg.data[2]}, ${dtimg.data[3]/255})`;
							ctx_cv.fill();
							
							//console.log([colbase.value.slice(1), hex[1]])
							
							var d1 = colDifHSL(colbase.value.slice(1), hex[1]);
							console.log(d1);
							//data.push()
							
							/*var d1 = hex[0]==false || hex[1]==false ? false : colDifHSL(hex[0], hex[1]);
							var d2 = hex[1]==false || hex[2]==false ? false : colDifHSL(hex[1], hex[2]);
							
							if(d1!=false){
								var i = data[data.length-1][1] == false ? data.length-1 : data.length;
								data[i] = data[i] == undefined ? [false, false] : data[i];
								var _b = false;
								if(d1.h >= 0.5 || d1.s >= 0.8 || d1.l >= 0.6 || d2.h >= 0.5 || d2.s >= 0.8 || d2.l >= 0.6){
									if(data[i][0] == false){
										data[i][0] = x;
									}else{
										data[i][1] = x;
									}
								}
							}*/
						}, 1);
					})(x)
				}
			}
			
			function cam(_vid, _camDT){
				if(vid.srcObject !== null){
					var x = vid.srcObject.getTracks();
					for(i in x){
						x[i].stop();
					}
				}
				var _vid=_vid, _camDT=_camDT;
				pro = navigator.mediaDevices.getUserMedia({
					video: _camDT
				}).then(function(stream){
					_vid.srcObject = stream
				});
				console.log(_camDT)
			}
		</script>
	</body>
</html>
